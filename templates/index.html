<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCRmyPDF Web Interface</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .upload-area {
            border: 2px dashed #007cba;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .upload-area:hover {
            background-color: #f0f8ff;
        }
        .upload-area.drag-over {
            background-color: #e6f3ff;
            border-color: #0056b3;
        }
        .file-input {
            display: none;
        }
        .upload-button {
            background-color: #007cba;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        .upload-button:hover {
            background-color: #0056b3;
        }
        .options {
            margin: 20px 0;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .option-group {
            margin-bottom: 15px;
        }
        .option-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        .option-group select, .option-group input[type="number"] {
            width: 200px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        .checkbox-group input[type="checkbox"] {
            margin-right: 8px;
        }
        .submit-button {
            background-color: #28a745;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 18px;
            width: 100%;
            margin-top: 20px;
        }
        .submit-button:hover {
            background-color: #218838;
        }
        .submit-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .progress {
            display: none;
            margin-top: 20px;
            text-align: center;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background-color: #007cba;
            width: 0%;
            transition: width 0.3s;
        }
        #progress-text {
            font-weight: bold;
            margin-bottom: 5px;
        }
        #current-file {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        #progress-percentage {
            font-weight: bold;
            margin-top: 5px;
        }
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        .file-info {
            margin-top: 10px;
            padding: 10px;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
            display: none;
        }
        #file-list {
            margin-top: 5px;
        }
        .file-item {
            padding: 5px 0;
            border-bottom: 1px solid #c3e6cb;
        }
        .file-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>OCRmyPDF Web Interface</h1>
        <p style="text-align: center; color: #666;">
            Upload a PDF or image file to add OCR text layer
        </p>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <form id="upload-form" action="{{ url_for('upload_file') }}" method="post" enctype="multipart/form-data">
            <div class="upload-area" id="upload-area">
                <div id="upload-text">
                    <p><strong>Click to select files or drag and drop</strong></p>
                    <p>Supported formats: PDF, PNG, JPG, TIFF, BMP, GIF</p>
                    <p>Maximum file size: 100MB per file</p>
                    <p>Select multiple files to batch process</p>
                </div>
                <input type="file" name="file" id="file-input" class="file-input" accept=".pdf,.png,.jpg,.jpeg,.tiff,.tif,.bmp,.gif" multiple required>
            </div>
            
            <div class="file-info" id="file-info">
                <strong>Selected files:</strong>
                <div id="file-list"></div>
            </div>

            <div class="options">
                <h3>OCR Options</h3>
                
                <div class="option-group">
                    <label for="language">Language:</label>
                    <select name="language" id="language">
                        <option value="eng">English</option>
                        <option value="deu">German</option>
                        <option value="fra">French</option>
                        <option value="spa">Spanish</option>
                        <option value="swe">Swedish</option>
                        <option value="ita">Italian</option>
                        <option value="por">Portuguese</option>
                        <option value="rus">Russian</option>
                        <option value="chi_sim">Chinese (Simplified)</option>
                        <option value="jpn">Japanese</option>
                    </select>
                </div>

                <div class="option-group">
                    <label for="optimize">Optimization Level:</label>
                    <select name="optimize" id="optimize">
                        <option value="0">None (fastest)</option>
                        <option value="1" selected>Basic optimization</option>
                        <option value="2">Aggressive optimization</option>
                        <option value="3">Maximum optimization (slowest)</option>
                    </select>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" name="force_ocr" id="force_ocr">
                    <label for="force_ocr">Force OCR on all pages (even if text already exists)</label>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" name="deskew" id="deskew">
                    <label for="deskew">Deskew pages</label>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" name="clean" id="clean">
                    <label for="clean">Clean pages before OCR</label>
                </div>
            </div>

            <button type="submit" class="submit-button" id="submit-button">
                Process files with OCR
            </button>
            
            <div class="progress" id="progress">
                <div id="progress-text">Processing files...</div>
                <div id="current-file"></div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div id="progress-percentage">0%</div>
            </div>
        </form>
    </div>

    <script>
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');
        const fileInfo = document.getElementById('file-info');
        const fileList = document.getElementById('file-list');
        const form = document.getElementById('upload-form');
        const submitButton = document.getElementById('submit-button');
        const progress = document.getElementById('progress');
        const progressFill = document.getElementById('progress-fill');
        const progressText = document.getElementById('progress-text');
        const currentFileText = document.getElementById('current-file');
        const progressPercentage = document.getElementById('progress-percentage');

        let selectedFiles = [];

        // Click to upload
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        // Drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('drag-over');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            
            const files = Array.from(e.dataTransfer.files);
            if (files.length > 0) {
                selectedFiles = files;
                // Update file input to match
                const dt = new DataTransfer();
                files.forEach(file => dt.items.add(file));
                fileInput.files = dt.files;
                showFileInfo();
            }
        });

        // File selection
        fileInput.addEventListener('change', (e) => {
            selectedFiles = Array.from(e.target.files);
            showFileInfo();
        });

        function showFileInfo() {
            if (selectedFiles.length === 0) {
                fileInfo.style.display = 'none';
                return;
            }

            fileList.innerHTML = '';
            selectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.textContent = `${index + 1}. ${file.name} (${formatFileSize(file.size)})`;
                fileList.appendChild(fileItem);
            });
            fileInfo.style.display = 'block';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Form submission
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (selectedFiles.length === 0) {
                alert('Please select at least one file first.');
                return;
            }
            
            submitButton.disabled = true;
            submitButton.textContent = 'Processing...';
            progress.style.display = 'block';
            
            const processedFiles = [];
            
            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                const progressPercent = Math.round((i / selectedFiles.length) * 100);
                
                progressFill.style.width = progressPercent + '%';
                progressPercentage.textContent = progressPercent + '%';
                currentFileText.textContent = `Processing: ${file.name}`;
                
                try {
                    const result = await processFile(file);
                    processedFiles.push(result);
                } catch (error) {
                    console.error('Error processing file:', file.name, error);
                    // Continue with other files
                }
            }
            
            // Complete
            progressFill.style.width = '100%';
            progressPercentage.textContent = '100%';
            currentFileText.textContent = 'Processing complete!';
            
            // Redirect to results page
            if (processedFiles.length > 0) {
                const fileIds = processedFiles.map(f => f.file_id).join(',');
                window.location.href = `/results?files=${fileIds}`;
            } else {
                alert('No files were processed successfully.');
                submitButton.disabled = false;
                submitButton.textContent = 'Process Files with OCR';
                progress.style.display = 'none';
            }
        });
        
        async function processFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('language', document.getElementById('language').value);
            formData.append('optimize', document.getElementById('optimize').value);
            if (document.getElementById('force_ocr').checked) {
                formData.append('force_ocr', 'on');
            }
            if (document.getElementById('deskew').checked) {
                formData.append('deskew', 'on');
            }
            if (document.getElementById('clean').checked) {
                formData.append('clean', 'on');
            }
            
            const response = await fetch('/api/process', {
                method: 'POST',
                body: formData
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            return await response.json();
        }
    </script>
</body>
</html>
